# 前端监控 SDK 开发过程中遇到的问题

## 用户行为监控模块

### 1. 页面跳转监控的挑战

**问题描述**：
在实现页面跳转监控时，需要同时处理多种路由变化方式（hash 变化、history API、popstate 事件），确保不遗漏任何页面跳转。

**解决方案**：

- 同时监听 `hashchange` 和 `popstate` 事件
- 重写 `history.pushState` 和 `history.replaceState` 方法
- 记录当前 URL，与新 URL 比较，避免重复记录

### 2. 点击行为收集的隐私保护

**问题描述**：
收集用户点击行为时，需要避免收集敏感信息（如密码），同时提供机制让开发者可以排除特定元素的监控。

**解决方案**：

- 对密码输入框特殊处理，不收集实际值
- 提供 `monitor-ignore` 类和 `data-monitor-ignore` 属性，让开发者可以标记不需要监控的元素
- 限制收集的元素内容长度，避免过多数据传输

### 3. UV 统计的准确性

**问题描述**：
UV（独立访客）统计需要在一定时间内避免重复计数，同时在用户清除本地存储后能够正确识别为新用户。

**解决方案**：

- 使用 localStorage 存储用户唯一标识和过期时间
- 设置合理的过期时间（默认 24 小时）
- 只有当用户是新用户或标识过期时才记录 UV

## rrweb 录屏和用户行为栈模块

### 1. rrweb 录屏数据量大的问题

**问题描述**：
rrweb 录屏产生的数据量很大，特别是当页面复杂或用户交互频繁时，可能会导致大量数据传输和存储压力。

**解决方案**：

- 限制录制时长，默认只保存 10 秒的录屏数据
- 提供配置选项控制录制内容，如是否录制 Canvas、控制台输出等
- 仅在错误发生时上报录屏数据，而非持续上报
- 对鼠标移动、滚动等高频事件进行采样

### 2. 敏感信息保护

**问题描述**：
录屏和行为栈可能会捕获到用户的敏感信息，如密码、个人信息等，需要避免收集和传输这些数据。

**解决方案**：

- 在 rrweb 中启用输入框遗漏保护（maskAllInputs）
- 在行为栈中实现敏感数据检测和遗漏机制
- 提供配置选项允许开发者自定义敏感关键词
- 支持通过 CSS 类标记不应该被录制的元素

### 3. 事件通信机制

**问题描述**：
需要实现插件之间的通信，特别是错误插件需要通知录屏和行为栈插件在错误发生时进行数据上报。

**解决方案**：

- 在 Monitor 核心类中实现事件发布/订阅机制
- 在 send 方法中触发相应类型的事件
- 允许插件通过 on/off 方法注册和取消事件监听

## 待解决问题

1. **跨域问题**：当用户在多个子域名下访问时，UV 统计可能不准确，需要考虑使用 Cookie 配合服务端解决
2. **离线数据处理**：当用户网络不可用时，行为数据无法发送，需要实现离线存储和重发机制
3. **数据量控制**：用户行为数据量可能很大，需要进一步优化采样策略和数据压缩
4. **录屏数据压缩**：录屏数据量大，需要实现数据压缩机制减少传输和存储开销
5. **服务端回放支持**：需要实现服务端对录屏数据的解析和回放支持
