# 前端监控 SDK 开发指南

## 用户行为监控模块实现指南

用户行为监控是前端监控系统的重要组成部分，通过收集用户在页面上的各种行为数据，可以帮助开发者了解用户如何使用产品，从而优化用户体验。

### 1. 模块设计原则

在实现用户行为监控模块时，我们遵循以下设计原则：

1. **插件化设计**：将不同类型的行为监控功能拆分为独立的插件，便于维护和扩展
2. **低侵入性**：监控代码不应影响页面的正常功能和性能
3. **隐私保护**：避免收集用户敏感信息，提供机制让开发者可以排除特定元素
4. **可配置性**：提供灵活的配置选项，让开发者可以根据需求调整监控行为
5. **数据精简**：只收集必要的数据，避免过多的数据传输

### 2. 核心功能实现

#### 2.1 PV/UV 统计

PV（页面浏览量）和 UV（独立访客量）是最基本的用户行为统计指标：

- **PV 实现**：
  - 在页面加载完成后记录一次 PV
  - 监听 `pageshow` 事件，处理从浏览器缓存加载的情况
  - 记录页面 URL、来源页面等信息

- **UV 实现**：
  - 使用 localStorage 存储用户唯一标识和过期时间
  - 设置合理的过期时间（如 24 小时）
  - 只有当用户是新用户或标识过期时才记录 UV

#### 2.2 点击行为收集

点击行为收集可以帮助了解用户与页面元素的交互情况：

- **事件监听**：
  - 监听 `click` 事件（桌面端）和 `touchstart` 事件（移动端）
  - 使用事件捕获阶段（而非冒泡阶段）以确保捕获所有点击

- **数据收集**：
  - 记录点击元素的标签名、ID、类名等基本信息
  - 记录点击位置坐标
  - 收集元素内容（可配置是否收集及最大长度）
  - 对密码输入框特殊处理，不收集实际值

- **排除机制**：
  - 提供 `monitor-ignore` 类，让开发者可以标记不需要监控的元素
  - 提供 `data-monitor-ignore` 属性，作为另一种排除方式

#### 2.3 页面跳转记录

页面跳转记录可以帮助了解用户的浏览路径：

- **多种路由监听**：
  - 监听 `hashchange` 事件，捕获 hash 路由变化
  - 监听 `popstate` 事件，捕获浏览器历史记录变化
  - 重写 `history.pushState` 和 `history.replaceState` 方法，捕获 history API 调用

- **数据收集**：
  - 记录跳转类型（hashchange/popstate/pushState/replaceState）
  - 记录来源 URL 和目标 URL
  - 提取 URL 的路径部分，便于分析

### 3. 最佳实践

1. **性能优化**：
   - 使用事件委托减少事件监听器数量
   - 对频繁触发的事件（如点击）进行节流处理
   - 批量发送数据，减少网络请求

2. **数据安全**：
   - 避免收集用户敏感信息
   - 提供明确的排除机制
   - 遵循数据最小化原则

3. **可用性提升**：
   - 提供详细的文档和示例
   - 添加调试日志，便于开发者排查问题
   - 提供配置选项，让开发者可以根据需求调整监控行为

### 4. 注意事项

1. **跨域问题**：
   - 当用户在多个子域名下访问时，localStorage 存储的用户标识可能不共享
   - 考虑使用 Cookie 配合服务端解决跨域问题

2. **SPA 应用**：
   - 单页应用中，页面不会完全重新加载，需要特别关注路由变化的监听
   - 确保 PV 统计在路由变化时也能正确记录

3. **隐私合规**：
   - 遵循 GDPR、CCPA 等隐私法规
   - 考虑提供选项让用户可以选择退出行为监控
   - 在隐私政策中明确说明收集的数据类型和用途
