# 前端监控 SDK 需求文档

## 项目概述

本项目旨在开发一个完整的前端监控 SDK，用于收集前端应用的错误、性能和用户行为数据，帮助开发团队快速定位和解决线上问题，优化用户体验，提供数据支持决策。

### 开发背景

在前端应用日益复杂的今天，线上问题定位困难，用户体验监控重要性凸显：

- **无法复现的 bug**：用户环境多样，无法知道用户具体操作路径和环境
- **错误预警**：需要及早发现并解决潜在问题，避免用户受到影响
- **性能监控**：需要采集关键性能指标，为优化提供方向
- **决策支持**：通过用户行为和性能数据分析，为产品规划提供依据

### 为什么自研而非使用 Sentry 等成熟方案

自研监控平台相比 Sentry 等成熟方案的优势：

1. 可统一公司各类 SDK（监控、埋点、录屏、广告等）
2. 可监控自定义个性化指标（如 long task、内存使用、首屏时间等）
3. 可统计资源缓存率，优化缓存策略
4. 提供更适合业务场景的白屏检测方案

## 功能需求

### 1. 数据采集

#### 1.1 错误监控

##### 1.1.1 JS 错误采集

- **语法错误**：通过 window.addEventListener('error')捕获
- **运行时错误**：通过 window.onerror 捕获
- **Promise 错误**：通过 window.addEventListener('unhandledrejection')捕获
- **逻辑错误**：通过 try/catch 手动上报

##### 1.1.2 静态资源加载错误

- 通过 window.addEventListener('error')捕获
- 针对图片、脚本、样式表等资源加载失败情况

##### 1.1.3 框架错误

- **Vue 错误**：通过 Vue.config.errorHandler 捕获
- **React 错误**：通过 ErrorBoundary 组件捕获

##### 1.1.4 接口错误

- 重写 XMLHttpRequest 和 fetch 方法
- 记录请求 URL、参数、状态码、响应数据、错误信息等
- 监控接口超时情况

##### 1.1.5 跨域错误处理

- 添加跨域资源共享配置（crossorigin 属性）
- 对于无法修改服务端配置的情况，提供降级处理方案

#### 1.2 性能监控

##### 1.2.1 基础性能指标

- **FP (First Paint)**：首次绘制时间
- **FCP (First Contentful Paint)**：首次内容绘制时间
- **LCP (Largest Contentful Paint)**：最大内容绘制时间
- **FID (First Input Delay)**：首次输入延迟
- **CLS (Cumulative Layout Shift)**：累积布局偏移
- **TTI (Time to Interactive)**：可交互时间
- **TBT (Total Blocking Time)**：总阻塞时间
- **INP (Interaction to Next Paint)**：交互到下一次绘制的时间

##### 1.2.2 资源加载性能

- 静态资源加载时间统计
- 资源大小统计
- DNS 解析时间
- 资源缓存率计算
- 关键资源加载瀑布图

##### 1.2.3 个性化指标

- **Long Task 监控**：记录执行时间超过 50ms 的任务
- **内存使用情况**：监控页面内存占用，预警可能的内存泄漏
- **首屏加载时间**：计算视口内 DOM 渲染完成的时间
- **白屏检测**：采用采样对比+轮询修正机制，检测页面是否长时间白屏

#### 1.3 用户行为监控

##### 1.3.1 路由跳转记录

- History 模式：监听 popstate 事件
- Hash 模式：监听 hashchange 事件
- 重写 history.pushState 和 history.replaceState 方法

##### 1.3.2 用户交互行为

- 点击行为：PC 端监听 mousedown/click，移动端监听 touchstart
- 表单操作：输入、提交、选择等
- 滚动行为：页面滚动位置和时间
- 停留时长：记录用户在页面的停留时长

##### 1.3.3 用户访问统计

- **PV (Page View)**：页面浏览量
- **UV (Unique Visitor)**：独立访客数
- **访问路径**：用户完整的访问路径记录
- **来源分析**：用户来源渠道分析

### 2. 数据上报

#### 2.1 上报方式

- **主要方式**：优先使用 navigator.sendBeacon（确保页面关闭前也能可靠上报）
- **备选方式 1**：图片打点上报（1x1 像素 GIF，跨域支持好，体积小）
- **备选方式 2**：XMLHttpRequest/fetch 上报
- **离线缓存**：当网络不可用时，将数据存储在本地，网络恢复后再上报

#### 2.2 上报内容

- **基础信息**：设备信息、浏览器信息、操作系统、页面 URL 等
- **错误信息**：错误类型、错误信息、错误堆栈、错误发生的页面位置等
- **性能数据**：关键性能指标、资源加载信息等
- **用户行为**：用户操作序列、点击位置、操作时间等
- **业务数据**：业务相关的自定义数据

#### 2.3 上报时机

- **实时上报**：严重错误、关键业务错误立即上报
- **性能指标**：页面加载完成后上报
- **批量上报**：一般错误和行为数据采用批量上报（提高性能）
- **离开上报**：在用户即将离开页面时上报（beforeunload 事件）
- **定时上报**：设置定时器定期上报缓存的数据
- **优化策略**：
  - 使用 requestIdleCallback 在浏览器空闲时上报
  - 使用微任务队列（Promise）批量处理上报
  - 设置上报频率限制，避免过多请求

### 3. 数据展示

#### 3.1 性能指标汇总

- **整体性能趋势图**：展示关键性能指标随时间的变化趋势
- **性能分布图**：展示不同性能指标的分布情况
- **性能分段统计**：按性能好、中、差分段统计用户比例
- **设备/浏览器性能对比**：不同设备、浏览器下的性能对比

#### 3.2 错误列表展示

- **错误概览**：错误发生次数、影响用户数等关键指标
- **错误详情**：错误堆栈、用户环境、复现步骤等
- **错误趋势**：错误发生频率随时间的变化
- **错误分类**：按错误类型、影响范围、严重程度等分类
- **关联分析**：错误与性能、用户行为的关联分析

#### 3.3 PV、UV 统计

- **访问量趋势图**：PV、UV 随时间的变化趋势
- **用户来源分析**：不同来源渠道的用户数量
- **用户留存分析**：用户留存率统计
- **页面热度分析**：各页面访问量排行
- **用户行为路径**：用户在站内的典型访问路径

### 4. 错误还原

#### 4.1 Sourcemap 定位

- **自动上传 sourcemap**：构建时自动上传 sourcemap 文件
- **错误堆栈解析**：通过 sourcemap 将线上压缩代码错误映射到源码位置
- **源码查看**：展示错误发生位置的源代码片段并高亮显示

#### 4.2 RRWeb 录屏

- **错误前后录屏**：记录错误发生前后 10 秒的用户操作
- **录屏回放**：支持录屏回放功能
- **录屏存储策略**：优化录屏存储，减少带宽和存储压力
- **录屏触发规则**：设置录屏触发的条件（如仅录制关键错误）

#### 4.3 用户行为栈

- **完整操作序列**：记录用户完整的操作序列
- **行为栈可视化**：将用户行为以时间轴方式可视化展示
- **关键节点标记**：标记出错误发生前的关键操作节点
- **行为与错误关联**：分析特定行为与错误的关联性

### 5. 监控和报警

#### 5.1 报警规则

- **错误数阈值**：当某类错误数超过阈值时触发报警
- **错误率阈值**：当错误发生率超过阈值时触发报警
- **性能阈值**：当性能指标超过阈值时触发报警
- **用户影响阈值**：当影响用户数超过阈值时触发报警
- **自定义规则**：支持自定义报警规则

#### 5.2 报警方式

- **即时通讯**：通过企业微信、钉钉等即时通讯工具推送报警
- **邮件报警**：发送报警邮件到相关责任人
- **短信报警**：重要报警通过短信发送
- **电话报警**：特别严重的问题通过电话报警
- **报警等级**：根据严重程度设置不同的报警等级和报警方式
- **报警收敛**：对同类报警进行收敛，避免报警风暴

## 非功能需求

### 1. 性能要求

- SDK 体积不超过 10KB（gzip 压缩后）
- SDK 初始化时间不超过 50ms
- 数据收集和上报不影响页面主线程性能
- 支持按需加载、Tree-Shaking

### 2. 稳定性要求

- SDK 自身不能产生错误，必须有完善的错误处理机制
- 即使在极端情况下也能保证主应用的正常运行
- 在低网络环境下依然能保证核心功能可用

### 3. 安全要求

- 所有上报数据必须经过加密处理
- 敏感信息（如密码、token 等）自动过滤不上报
- 符合隐私保护法规要求，用户数据匿名化处理

### 4. 兼容性要求

- 支持主流浏览器（Chrome、Firefox、Safari、Edge 等）
- 支持移动端浏览器（Safari、Chrome for Android 等）
- 兼容 IE11 及以上版本（可降级功能）
- 兼容主流前端框架（Vue、React、Angular 等）

### 5. 可扩展性要求

- 插件化架构，便于功能扩展
- 提供完善的自定义接口
- 支持自定义数据采集和上报

## 接入要求

- 提供简单的一键接入方式
- 详细的接入文档和示例
- 灵活的配置选项
- 多环境支持（开发、测试、生产）

## 项目规划

### 第一阶段：基础功能开发

- 错误监控基础功能
- 性能监控基础指标采集
- 基础数据上报功能

### 第二阶段：增强功能开发

- 用户行为监控
- 高级性能指标采集
- RRWeb 录屏功能
- Sourcemap 错误还原

### 第三阶段：完善与优化

- 报警系统对接
- 数据分析功能增强
- 性能优化
- 全面测试和文档完善

## 后续规划

- 增加智能分析功能，自动发现异常
- 增加 AI 辅助分析错误原因
- 提供更丰富的数据可视化展示
- 对接业务系统，实现更深入的业务分析
